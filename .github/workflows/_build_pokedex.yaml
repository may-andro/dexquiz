name: Build Pokedex

on:
  workflow_call:
    inputs:
      flavor:
        type: string
        required: true

env:
  DART_SDK_VERSION: 3.1.2
  PATH_POKEDEX_BUILDER: ./tools/pokedex_builder

jobs:
  build_pokedex:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ${{ env.PATH_POKEDEX_BUILDER }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup dart environment
        uses: dart-lang/setup-dart@v1
        with:
          sdk: ${{ env.DART_SDK_VERSION }}

      - name: Format the Dart code
        run: dart format . --set-exit-if-changed

      - name: Run the code generators
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Install dependencies for pokedex_builder
        run: dart pub get

      - name: Statically analyze the Dart code
        run: dart analyze

      - name: Run the unit tests
        run: dart test --file-reporter "json:test-results.json"

      - name: Generate Test Report
        run: |
          dart pub global activate coverage
          dart pub global run coverage:collect_coverage --out=coverage.json --resume-isolates --wait-paused
          dart pub global run coverage:format_coverage --lcov --in=coverage.json --out=lcov.info --packages=.packages --report-on=lib

      - name: Publish Test Report as Comment
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('lcov.info', 'utf8');
            github.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'Test Coverage Report:\n```lcov\n' + report + '\n```',
            });

      - name: Generate the test report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Test Results
          path: test-results.json
          reporter: dart-json
          working-directory: ${{ env.PATH_POKEDEX_BUILDER }}

      - name: Create JSON File
        id: create-json
        run: echo '' > temporary.json

      - name: Fetch, build and create firestore collection json
        run: dart bin/pokedex_builder.dart build --flavor ${{ inputs.flavor }} --path temporary.json

      - name: Print the created json file
        run: cat temporary.json


